<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng từ đơn - Bootstrap</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome - cung cấp biểu tượng xe và nút điều khiển -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Thiết lập nền trang */
        body {
            background-color: #f8f9fa;
        }

        /* Khu vực mô phỏng chính - chiều cao cố định và ẩn phần tràn */
        .simulation-area {
            position: relative;
            height: 450px;
            overflow: hidden;
        }

        /* Đường giao thông - nơi xe di chuyển */
        .road {
            position: absolute;
            width: 100%;
            height: 100px;
            background-color: #495057;
            top: 80px;
            border-radius: 5px;
        }

        /* Vạch kẻ đường - được tạo động bằng JavaScript */
        .road-marking {
            position: absolute;
            width: 30px;
            height: 6px;
            background-color: white;
            top: 127px;
        }

        /* Vòng từ - cảm biến đặt trên mặt đường */
        .loop-sensor {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 4px solid #fa5252;
            background-color: rgba(250, 82, 82, 0.2);
            top: 90px;
            left: 50%;
            transform: translateX(-40px);
            z-index: 2;
            border-radius: 10px;
        }

        /* Xe - đối tượng di chuyển qua vòng từ */
        .vehicle {
            position: absolute;
            height: 50px;
            background-color: #4dabf7;
            border-radius: 8px;
            top: 105px;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            z-index: 4;
        }

        /* Đường tín hiệu cơ sở - đường cơ bản của tín hiệu điện */
        .signal-pulse {
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #adb5bd;
            top: 220px;
        }

        /* Phần cao của tín hiệu - hiển thị khi xe đi qua vòng từ */
        .pulse-high {
            position: absolute;
            width: 80px;
            height: 0px;
            background-color: #fa5252;
            top: 220px;
            left: 50%;
            transform: translateX(-40px);
            transition: height 0.3s;
        }

        /* Bộ đếm thời gian di chuyển cùng xe */
        .moving-timer {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 15px;
            padding: 4px 12px;
            top: 70px;
            left: 0;
            z-index: 5;
        }

        /* Đánh dấu thời gian tại điểm vào/ra vòng từ */
        .loop-time-marker {
            position: absolute;
            width: 2px;
            height: 300px;
            background-color: rgba(250, 82, 82, 0.8);
            top: 80px;
            z-index: 1;
            display: none;
            /* Ẩn ban đầu, chỉ hiển thị khi xe tương tác */
        }

        /* Giá trị thời gian tại điểm vào/ra vòng từ */
        .loop-time-value {
            position: absolute;
            background-color: rgba(250, 82, 82, 0.9);
            color: white;
            border-radius: 10px;
            padding: 4px 8px;
            top: 40px;
            transform: translateX(-50%);
            z-index: 5;
            display: none;
            /* Ẩn ban đầu, chỉ hiển thị khi xe tương tác */
        }

        /* Đánh dấu khoảng thời gian xe chiếm dụng vòng từ */
        .occupancy-marker {
            position: absolute;
            height: 5px;
            background-color: #20c997;
            top: 260px;
            z-index: 1;
            display: none;
            /* Ẩn ban đầu, chỉ hiển thị khi xe tương tác */
        }

        /* Nhãn hiển thị thời gian chiếm dụng */
        .occupancy-label {
            position: absolute;
            color: #20c997;
            top: 240px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            /* Ẩn ban đầu, chỉ hiển thị khi xe tương tác */
        }

        /* Bố cục hàng dữ liệu trong bảng điều khiển */
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Khung hiển thị công thức vòng từ */
        .formula-box {
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid #20c997;
            border-radius: 10px;
            padding: 15px;
            line-height: 1.5;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <!-- Tiêu đề và mô tả -->
        <h1 class="text-center mb-2">Nguyên lý hoạt động của vòng từ đơn</h1>
        <h4 class="text-center text-muted mb-4">Ước tính tốc độ bằng vòng từ đơn</h4>

        <div class="row">
            <!-- Khu vực hiển thị mô phỏng - chiếm 9/12 độ rộng trên màn hình lớn -->
            <div class="col-lg-9">
                <div class="card shadow simulation-area mb-4">
                    <!-- Đường giao thông -->
                    <div class="road"></div>
                    <!-- Vạch kẻ đường - được tạo bởi JavaScript -->

                    <!-- Vòng từ - cảm biến từ trên đường -->
                    <div class="loop-sensor">
                        <div class="text-center mt-5 small bg-white rounded px-1">Độ rộng: 2m</div>
                    </div>

                    <!-- Xe di chuyển qua vòng từ -->
                    <div id="vehicle" class="vehicle px-3">
                        <i class="fas fa-car me-2"></i>
                        <span id="speed-display">50 km/h</span>
                    </div>

                    <!-- Các phần tử hiển thị thời gian và đánh dấu -->
                    <div id="moving-timer" class="moving-timer">0.00s</div>
                    <div id="loop-entry-marker" class="loop-time-marker"></div>
                    <div id="loop-entry-value" class="loop-time-value"></div>
                    <div id="loop-exit-marker" class="loop-time-marker"></div>
                    <div id="loop-exit-value" class="loop-time-value"></div>
                    <div id="occupancy-marker" class="occupancy-marker"></div>
                    <div id="occupancy-label" class="occupancy-label"></div>

                    <!-- Tín hiệu xung điện - hiển thị trạng thái vòng từ -->
                    <div class="signal-pulse"></div>
                    <div id="pulse-high" class="pulse-high"></div>

                    <!-- Công thức tính tốc độ vòng từ đơn -->
                    <div class="formula-box position-absolute bottom-0 start-50 translate-middle-x mb-2 text-center">
                        Vòng từ đơn:<br>
                        - Công thức ước tính: v ≈ q/k<br>
                        - Trong đó q là lưu lượng (số xe/giờ)<br>
                        - và k là mật độ (số xe/km)
                    </div>
                </div>
            </div>

            <!-- Bảng điều khiển mô phỏng - chiếm 3/12 độ rộng màn hình lớn -->
            <div class="col-lg-3">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h5 class="mb-0">Điều khiển mô phỏng</h5>
                    </div>
                    <div class="card-body">
                        <!-- Hiển thị thông số đo lường và thiết lập -->
                        <div class="mb-3">
                            <div class="data-row">
                                <span class="fw-bold">Tốc độ xe:</span>
                                <span id="speed-value" class="text-primary fw-bold">50 km/h</span>
                            </div>
                            <div class="data-row">
                                <span class="fw-bold">Thời gian chiếm dụng:</span>
                                <span id="time-value" class="text-primary fw-bold">0.072 giây</span>
                            </div>
                            <div class="data-row">
                                <span class="fw-bold">Độ rộng vòng từ:</span>
                                <span class="text-primary fw-bold">2.0 mét</span>
                            </div>
                            <div class="data-row">
                                <span class="fw-bold">Chiều dài xe:</span>
                                <span id="length-value" class="text-primary fw-bold">3.0 mét</span>
                            </div>
                        </div>

                        <!-- Điều khiển tham số mô phỏng -->
                        <div class="mb-3">
                            <label for="speed-slider" class="form-label fw-bold">Tốc độ xe (10-100 km/h):</label>
                            <input type="range" class="form-range" id="speed-slider" min="10" max="100" value="50"
                                step="1">
                        </div>
                        <div class="mb-3">
                            <label for="length-slider" class="form-label fw-bold">Chiều dài xe (2-10m):</label>
                            <input type="range" class="form-range" id="length-slider" min="2" max="10" value="3"
                                step="0.1">
                        </div>
                        <div class="d-grid gap-2">
                            <button id="start-button" class="btn btn-primary fw-bold">
                                <i class="fas fa-play me-2"></i>Bắt đầu
                            </button>
                            <button id="reset-button" class="btn btn-secondary fw-bold">
                                <i class="fas fa-redo-alt me-2"></i>Đặt lại
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery và Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // PHẦN 1: KHỞI TẠO MÔI TRƯỜNG MÔ PHỎNG
            // Tạo vạch kẻ đường động để thích ứng với kích thước màn hình
            const roadWidth = $('.road').width();
            const spacing = roadWidth / 13;

            for (let i = 0; i < 13; i++) {
                $('.simulation-area').append(`<div class="road-marking" style="left: ${spacing * i + spacing / 2}px;"></div>`);
            }

            // PHẦN 2: CACHE CÁC PHẦN TỬ DOM ĐỂ TỐI ƯU HIỆU SUẤT
            const $vehicle = $('#vehicle');
            const $pulseHigh = $('#pulse-high');
            const $movingTimer = $('#moving-timer');
            const $loopEntryMarker = $('#loop-entry-marker');
            const $loopEntryValue = $('#loop-entry-value');
            const $loopExitMarker = $('#loop-exit-marker');
            const $loopExitValue = $('#loop-exit-value');
            const $occupancyMarker = $('#occupancy-marker');
            const $occupancyLabel = $('#occupancy-label');

            // PHẦN 3: THIẾT LẬP BIẾN ĐIỀU KHIỂN VÀ THAM SỐ VẬT LÝ
            let animationId = null;     // ID của animation frame, dùng để hủy animation
            let vehicleSpeed = 50;      // Tốc độ xe (km/h)
            let vehicleLength = 3;      // Chiều dài xe (m)
            let loopWidth = 2;          // Độ rộng vòng từ (m)
            let animationSpeed = 0.05;  // Hệ số tốc độ animation (càng nhỏ càng chậm)
            let isAnimating = false;    // Trạng thái đang chạy animation

            // PHẦN 4: BIẾN THEO DÕI THỜI GIAN
            let startTime = 0;          // Thời điểm bắt đầu animation
            let loopEntryTime = null;   // Thời điểm xe bắt đầu đi vào vòng từ
            let loopExitTime = null;    // Thời điểm xe hoàn toàn rời khỏi vòng từ
            let currentTime = 0;        // Thời gian hiện tại trong mô phỏng

            // PHẦN 5: XÁC ĐỊNH CÁC VỊ TRÍ QUAN TRỌNG
            const roadStartX = 0;                    // Điểm bắt đầu đường
            const roadEndX = roadWidth;              // Điểm kết thúc đường
            const loopX = roadWidth / 2 - 40;        // Vị trí bắt đầu vòng từ
            const loopEndX = loopX + 80;             // Vị trí kết thúc vòng từ
            const pixelsPerMeter = roadWidth / 25;   // Tỉ lệ pixel/meter cho tính toán

            // PHẦN 6: CẬP NHẬT HIỂN THỊ BAN ĐẦU VÀ KHI THAM SỐ THAY ĐỔI
            function updateDisplayInfo() {
                // Cập nhật hiển thị tốc độ
                $('#speed-value, #speed-display').text(vehicleSpeed + ' km/h');

                // Tính thời gian chiếm dụng lý thuyết = (chiều dài xe + độ rộng vòng từ) / tốc độ(m/s)
                const speedInMPS = vehicleSpeed / 3.6; // Chuyển từ km/h sang m/s
                const occupancyTime = (vehicleLength + loopWidth) / speedInMPS;
                $('#time-value').text(occupancyTime.toFixed(3) + ' giây');

                // Cập nhật hiển thị chiều dài xe
                $('#length-value').text(vehicleLength.toFixed(1) + ' mét');

                // Thay đổi chiều dài xe trong giao diện
                $vehicle.width((vehicleLength * pixelsPerMeter) + 'px');

                // Đặt lại thanh thời gian di chuyển
                $movingTimer.text('0.00s').css('left', roadStartX + 'px');

                // Ẩn tất cả đánh dấu thời gian và chiếm dụng
                $loopEntryMarker.hide();
                $loopEntryValue.hide();
                $loopExitMarker.hide();
                $loopExitValue.hide();
                $occupancyMarker.hide();
                $occupancyLabel.hide();
            }

            // PHẦN 7: XỬ LÝ SỰ KIỆN THAY ĐỔI TỐC ĐỘ XE
            $('#speed-slider').on('input', function () {
                vehicleSpeed = parseInt($(this).val());
                updateDisplayInfo();
            });

            // PHẦN 8: XỬ LÝ SỰ KIỆN THAY ĐỔI CHIỀU DÀI XE
            $('#length-slider').on('input', function () {
                vehicleLength = parseFloat($(this).val());
                updateDisplayInfo();
            });

            // PHẦN 9: XỬ LÝ SỰ KIỆN BẮT ĐẦU MÔ PHỎNG
            $('#start-button').click(function () {
                if (isAnimating) return;
                isAnimating = true;

                // Đặt lại các biến thời gian theo dõi
                loopEntryTime = null;
                loopExitTime = null;
                currentTime = 0;

                // Đặt xe về vị trí ban đầu
                $vehicle.css('left', roadStartX + 'px');
                $movingTimer.text('0.00s').css('left', roadStartX + 'px');

                // Ẩn tất cả đánh dấu thời gian
                $loopEntryMarker.hide();
                $loopEntryValue.hide();
                $loopExitMarker.hide();
                $loopExitValue.hide();
                $occupancyMarker.hide();
                $occupancyLabel.hide();

                // Tính toán tham số animation dựa trên tốc độ xe
                const roadLength = roadEndX - roadStartX; // chiều dài đường (pixels)
                const timeToCompleteAnimation = roadLength / (vehicleSpeed * animationSpeed / 10);

                // Ghi lại thời điểm bắt đầu thực tế
                startTime = performance.now();

                // PHẦN 10: HÀM XỬ LÝ ANIMATION CHÍNH
                function animateVehicle(timestamp) {
                    // Tính toán thời gian đã trôi qua từ khi bắt đầu
                    const elapsedTime = timestamp - startTime;
                    // Tính phần trăm hoàn thành của animation
                    const progress = elapsedTime / timeToCompleteAnimation;

                    if (progress < 1) {
                        // PHẦN 10A: TÍNH THỜI GIAN VÀ DI CHUYỂN XE
                        // Tính thời gian hiện tại trong mô phỏng (giây)
                        currentTime = progress * (roadLength / (vehicleSpeed / 3.6 * pixelsPerMeter));

                        // Di chuyển xe dựa trên tiến độ animation
                        const position = roadStartX + progress * roadLength;
                        $vehicle.css('left', position + 'px');

                        // Di chuyển thanh thời gian cùng với xe
                        const vehicleWidth = $vehicle.width();
                        $movingTimer.css('left', (position + vehicleWidth / 2 - 30) + 'px')
                            .text(currentTime.toFixed(2) + 's');

                        // PHẦN 10B: PHÁT HIỆN TƯƠNG TÁC VỚI VÒNG TỪ
                        // Tính vị trí cạnh phải và trái của xe
                        const vehicleRight = position + vehicleWidth;
                        const vehicleLeft = position;

                        // Phát hiện khi xe bắt đầu vào vòng từ (cạnh trước chạm vòng từ)
                        if (!loopEntryTime && vehicleRight >= loopX && vehicleLeft < loopX) {
                            loopEntryTime = currentTime;
                            $loopEntryMarker.css('left', loopX + 'px').show();
                            $loopEntryValue.css('left', loopX + 'px').text(loopEntryTime.toFixed(2) + 's').show();
                        }

                        // Phát hiện khi xe hoàn toàn rời khỏi vòng từ (cạnh sau rời khỏi vòng từ)
                        if (!loopExitTime && loopEntryTime && vehicleLeft > loopEndX) {
                            loopExitTime = currentTime;
                            $loopExitMarker.css('left', loopEndX + 'px').show();
                            $loopExitValue.css('left', loopEndX + 'px').text(loopExitTime.toFixed(2) + 's').show();

                            // Hiển thị thông tin thời gian chiếm dụng vòng từ
                            if (loopEntryTime) {
                                const occupancyTime = loopExitTime - loopEntryTime;
                                $('#time-value').text(occupancyTime.toFixed(3) + ' giây');

                                $occupancyMarker.css({
                                    'left': loopX + 'px',
                                    'width': (loopEndX - loopX) + 'px'
                                }).show();

                                $occupancyLabel.css('left', (loopX + (loopEndX - loopX) / 2 - 60) + 'px')
                                    .text('Chiếm dụng: ' + occupancyTime.toFixed(2) + 's')
                                    .show();
                            }
                        }

                        // Cập nhật trạng thái tín hiệu xung khi xe đang ở trên vòng từ
                        if ((vehicleRight >= loopX && vehicleLeft < loopEndX) ||
                            (vehicleLeft <= loopEndX && vehicleRight > loopX)) {
                            // Xe đang ở trên vòng từ - hiển thị xung cao
                            $pulseHigh.css({
                                'height': '50px',
                                'top': '170px'
                            });
                        } else {
                            // Xe không ở trên vòng từ - hiển thị xung thấp
                            $pulseHigh.css({
                                'height': '0px',
                                'top': '220px'
                            });
                        }

                        // Tiếp tục vòng lặp animation
                        animationId = requestAnimationFrame(animateVehicle);
                    } else {
                        // PHẦN 10C: KẾT THÚC ANIMATION
                        $vehicle.css('left', roadEndX + 'px');
                        $pulseHigh.css({
                            'height': '0px',
                            'top': '220px'
                        });
                        isAnimating = false;
                    }
                }

                // Bắt đầu animation loop
                animationId = requestAnimationFrame(animateVehicle);
            });

            // PHẦN 11: XỬ LÝ SỰ KIỆN ĐẶT LẠI MÔ PHỎNG
            $('#reset-button').click(function () {
                // Hủy animation đang chạy nếu có
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }

                // Đặt lại vị trí xe và thanh thời gian
                $vehicle.css('left', roadStartX + 'px');
                $movingTimer.css('left', roadStartX + 'px').text('0.00s');
                $pulseHigh.css({
                    'height': '0px',
                    'top': '220px'
                });

                // Ẩn tất cả đánh dấu thời gian
                $loopEntryMarker.hide();
                $loopEntryValue.hide();
                $loopExitMarker.hide();
                $loopExitValue.hide();
                $occupancyMarker.hide();
                $occupancyLabel.hide();

                // Đặt lại các biến thời gian
                loopEntryTime = null;
                loopExitTime = null;
                currentTime = 0;

                isAnimating = false;
            });

            // PHẦN 12: KHỞI TẠO MÔ PHỎNG
            // Cập nhật hiển thị ban đầu
            updateDisplayInfo();
        });
    </script>
</body>

</html>
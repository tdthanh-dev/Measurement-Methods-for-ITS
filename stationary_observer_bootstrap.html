<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trạm quan sát đứng yên - Bootstrap</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Thiết lập nền trang */
        body {
            background-color: #f8f9fa;
        }

        /* Khu vực mô phỏng chính */
        .simulation-area {
            position: relative;
            height: 450px;
            overflow: hidden;
            background-color: white;
        }

        /* Đường giao thông - màu nền xám đại diện cho mặt đường */
        .road {
            position: absolute;
            width: 100%;
            height: 240px;
            background-color: #495057;
            top: 80px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Phân cách giữa 2 hướng đường */
        .road-divider {
            position: absolute;
            width: 100%;
            height: 6px;
            background-color: #ffd43b;
            top: 197px;
            z-index: 2;
        }

        /* Vạch kẻ phân làn đường đi lên */
        .lane-divider-up {
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #fff;
            top: 138px;
            z-index: 2;
            border-style: dashed;
        }

        /* Vạch kẻ phân làn đường đi xuống */
        .lane-divider-down {
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #fff;
            top: 255px;
            z-index: 2;
            border-style: dashed;
        }

        /* Làn đường bên phải - chiều đi lên - làn nhanh */
        .lane-up-fast {
            position: absolute;
            width: 100%;
            height: 55px;
            top: 82px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px 5px 0 0;
        }

        /* Làn đường bên phải - chiều đi lên - làn chậm */
        .lane-up-slow {
            position: absolute;
            width: 100%;
            height: 55px;
            top: 142px;
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* Làn đường bên trái - chiều đi xuống - làn nhanh */
        .lane-down-fast {
            position: absolute;
            width: 100%;
            height: 55px;
            top: 203px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Làn đường bên trái - chiều đi xuống - làn chậm */
        .lane-down-slow {
            position: absolute;
            width: 100%;
            height: 55px;
            top: 263px;
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 0 0 5px 5px;
        }

        /* Xe thăm dò - xe đo lường (phương tiện màu xanh lá) */
        .probe-car {
            position: absolute;
            width: 120px;
            height: 50px;
            background-color: #20c997;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #0ca678;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            top: 100px !important;
            /* Cố định vị trí thẳng giữa làn nhanh đi lên */
        }

        /* Xe đi lên (màu xanh dương) */
        .car-up {
            position: absolute;
            width: 80px;
            height: 40px;
            background-color: #4dabf7;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        /* Xe đi xuống (màu cam) */
        .car-down {
            position: absolute;
            width: 80px;
            height: 40px;
            background-color: #fd7e14;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: rotate(180deg);
        }

        /* Đoạn đường di chuyển */
        .probe-timeline {
            position: absolute;
            width: 700px;
            height: 2px;
            background-color: #adb5bd;
            top: 380px;
            left: 50px;
        }

        /* Đánh dấu thời gian */
        .time-marker {
            position: absolute;
            width: 2px;
            height: 10px;
            background-color: #495057;
            top: 375px;
        }

        /* Nhãn thời gian */
        .time-label {
            position: absolute;
            top: 390px;
            font-size: 12px;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Điểm dữ liệu của xe thăm dò */
        .probe-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #20c997;
            border: 2px solid #0ca678;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        /* Đường đi của xe thăm dò trong biểu đồ */
        .probe-path {
            position: absolute;
            height: 2px;
            background-color: #20c997;
            top: 330px;
        }

        /* Khung hiển thị công thức và giải thích */
        .formula-box {
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #20c997;
            border-radius: 10px;
            padding: 15px;
            line-height: 1.5;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Các hàng dữ liệu trong bảng điều khiển */
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        /* Màu cho giá trị tính toán */
        .calculated {
            color: #20c997;
        }

        /* Animation di chuyển cho xe đi lên (từ trái sang phải) */
        @keyframes moveCarUp {
            0% {
                left: 25px;
            }

            100% {
                left: calc(100% - 150px);
            }
        }

        /* Animation di chuyển cho xe đi xuống (từ phải sang trái) */
        @keyframes moveCarDown {
            0% {
                left: calc(100% - 150px);
            }

            100% {
                left: 25px;
            }
        }

        /* Vạch kẻ dọc thể hiện điểm đếm xe */
        .counting-line {
            position: absolute;
            width: 3px;
            height: 240px;
            background-color: #ff0800;
            right: 25px;
            top: -15px;
            z-index: 11;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* Trạm quan sát đứng yên (phương tiện màu xanh lá) */
        #stationary-observer {
            position: absolute;
            width: 80px;
            height: 60px;
            background-color: #20c997;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #0ca678;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            top: 20px;
            left: 450px;
        }


        /* CSS cho thiết bị di động */
        @media (max-width: 767.98px) {

            /* Hiển thị nút bắt đầu lại trên thiết bị di động */
            #mobile-restart-button {
                display: block !important;
                font-size: 1.2rem;
                width: 40px;
                height: 40px;
                padding: 0.25rem;
                border-radius: 50%;
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <!-- Tiêu đề và mô tả -->
        <h1 class="text-center mb-2">Trạm quan sát đứng yên (Stationary Observer)</h1>
        <h4 class="text-center text-muted mb-4">Phương pháp đo lường thông số giao thông bằng trạm đứng yên</h4>

        <div class="row">
            <!-- Khu vực hiển thị mô phỏng - chiếm 8/12 độ rộng trên màn hình lớn -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Mô phỏng trạm quan sát đứng yên</h5>
                    </div>
                    <div class="card-body simulation-area">
                        <!-- Đường giao thông hai chiều với phân làn -->
                        <div class="road"></div>
                        <div class="lane-up-fast"></div>
                        <div class="lane-up-slow"></div>
                        <div class="lane-down-fast"></div>
                        <div class="lane-down-slow"></div>
                        <div class="road-divider"></div>
                        <div class="lane-divider-up"></div>
                        <div class="lane-divider-down"></div>

                        <!-- Vạch kẻ đường đứt đoạn được tạo động bằng JavaScript -->

                        <!-- Vạch đếm xe cho trạm quan sát -->
                        <div class="counting-line"
                            style="position: absolute; left: 450px; top: 80px; height: 240px; width: 5px; background-color: #ff0800; z-index: 10;">
                        </div>

                        <!-- Xe thăm dò - đặt ở lề đường -->
                        <div id="stationary-observer" style="top: 20px; left: 450px;">
                            <i class="fas fa-video me-1"></i>
                            <span>Xe dừng</span>
                        </div>

                        <!-- Các xe đi lên làn nhanh (chiều từ trái sang phải) -->
                        <div id="car-up-fast-1" class="car-up" style="top: 95px; left: 0px; visibility: hidden;">
                            <span>A1</span>
                        </div>
                        <div id="car-up-fast-2" class="car-up" style="top: 95px; left: 0px; visibility: hidden;">
                            <span>A2</span>
                        </div>

                        <!-- Các xe đi lên làn chậm (chiều từ trái sang phải) -->
                        <div id="car-up-slow-1" class="car-up" style="top: 155px; left: 0px; visibility: hidden;">
                            <span>A3</span>
                        </div>
                        <div id="car-up-slow-2" class="car-up" style="top: 155px; left: 0px; visibility: hidden;">
                            <span>A4</span>
                        </div>

                        <!-- Các xe đi xuống làn nhanh (chiều từ phải sang trái) -->
                        <div id="car-down-fast-1" class="car-down" style="top: 215px; left: 0px; visibility: hidden;">
                            <span>B1</span>
                        </div>
                        <div id="car-down-fast-2" class="car-down" style="top: 215px; left: 0px; visibility: hidden;">
                            <span>B2</span>
                        </div>

                        <!-- Các xe đi xuống làn chậm (chiều từ phải sang trái) -->
                        <div id="car-down-slow-1" class="car-down" style="top: 275px; left: 0px; visibility: hidden;">
                            <span>B3</span>
                        </div>
                        <div id="car-down-slow-2" class="car-down" style="top: 275px; left: 0px; visibility: hidden;">
                            <span>B4</span>
                        </div>

                        <!-- Biểu đồ dữ liệu thu thập theo thời gian -->
                        <div class="probe-timeline"></div>

                        <!-- Đánh dấu và nhãn thời gian -->
                        <div class="time-marker" style="left: 50px;"></div>
                        <div class="time-label" style="left: 50px;">0 phút</div>

                        <div class="time-marker" style="left: 190px;"></div>
                        <div class="time-label" style="left: 190px;">5 phút</div>

                        <div class="time-marker" style="left: 330px;"></div>
                        <div class="time-label" style="left: 330px;">10 phút</div>

                        <div class="time-marker" style="left: 470px;"></div>
                        <div class="time-label" style="left: 470px;">15 phút</div>

                        <div class="time-marker" style="left: 610px;"></div>
                        <div class="time-label" style="left: 610px;">20 phút</div>

                        <div class="time-marker" style="left: 750px;"></div>
                        <div class="time-label" style="left: 750px;">25 phút</div>

                        <!-- Nút bắt đầu lại trên giao diện điện thoại -->
                        <button id="mobile-restart-button" class="btn btn-danger position-absolute"
                            style="top: 10px; right: 10px; display: none; z-index: 10;">
                            <i class="fas fa-redo-alt"></i>
                        </button>

                        <!-- Đường đi và điểm dữ liệu của xe thăm dò -->
                        <!-- <div class="probe-path" style="left: 50px; width: 700px;"></div> -->

                        <!-- Các điểm dữ liệu của xe thăm dò -->
                        <!-- <div class="probe-point" style="left: 50px; top: 330px;"></div>
                        <div class="probe-point" style="left: 190px; top: 300px;"></div>
                        <div class="probe-point" style="left: 330px; top: 270px;"></div>
                        <div class="probe-point" style="left: 470px; top: 300px;"></div>
                        <div class="probe-point" style="left: 610px; top: 330px;"></div>
                        <div class="probe-point" style="left: 750px; top: 310px;"></div> -->

                        <!-- Công thức tính toán dựa trên xe thăm dò -->
                        <div class="formula-box position-fixed start-50 translate-middle-x"
                            style="top: 50%; transform: translate(-50%, -50%); max-width: 600px; z-index: 1050;">
                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close"
                                id="close-formula"></button>
                            <h5 class="text-center mb-3">Phương pháp trạm quan sát đứng yên (Stationary Observer)</h5>
                            - Công thức tính lưu lượng: q = n / T
                            <p class="mt-2 mb-0">
                                <small>Trong đó: n là số xe đi qua điểm đo trong thời gian T (phút)</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Chú thích các ký hiệu -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Chú thích</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <div
                                        style="width: 30px; height: 20px; background-color: #20c997; border-radius: 4px; margin-right: 10px;">
                                    </div>
                                    <span>Trạm quan sát đứng yên</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <div
                                        style="width: 30px; height: 20px; background-color: #4dabf7; border-radius: 4px; margin-right: 10px;">
                                    </div>
                                    <span>Xe đi lên</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <div
                                        style="width: 30px; height: 20px; background-color: #fd7e14; border-radius: 4px; margin-right: 10px;">
                                    </div>
                                    <span>Xe đi xuống</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="mb-0"><strong>Vạch đỏ dọc</strong>: Vạch đếm xe tại trạm quan sát</p>
                            <p class="mb-0"><strong>n</strong>: Số xe đi qua điểm đo trong thời gian T</p>
                        </div>
                    </div>
                </div>

                <!-- Ô giải thích và thông tin bổ sung -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Giải thích về phương pháp xe thăm dò đứng yên</h5>
                    </div>
                    <div class="card-body">
                        <p>Phương pháp xe thăm dò đứng yên (Stationary Observer) là kỹ thuật đo lường các thông số giao
                            thông bằng cách đặt một điểm quan sát cố định bên đường và đếm số lượng xe đi qua trong một
                            khoảng thời gian.</p>
                        <p>Trong mô phỏng này, trạm quan sát đặt tại vị trí cố định trên đường hai chiều với mỗi chiều
                            có hai làn đường. Hệ thống sẽ đếm các xe đi qua điểm đo và theo dõi số lượng xe trong một
                            đoạn đường có chiều dài xác định.</p>
                        <div class="row">
                            <div class="col-md-6">
                                <p><span class="fw-bold text-primary">Ưu điểm của phương pháp đứng yên:</span></p>
                                <ul>
                                    <li>Đơn giản, dễ thực hiện và ít tốn kém</li>
                                    <li>Có thể sử dụng camera hoặc cảm biến tự động</li>
                                    <li>Độ chính xác cao trong việc đếm số lượng xe</li>
                                    <li>Dễ dàng đo lường lưu lượng giao thông (xe/giờ)</li>
                                    <li>Có thể thu thập dữ liệu liên tục trong thời gian dài</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <p><span class="fw-bold text-danger">Hạn chế:</span></p>
                                <ul>
                                    <li>Chỉ thu thập dữ liệu tại một vị trí cố định</li>
                                    <li>Không cung cấp thông tin về thời gian di chuyển</li>
                                    <li>Khó xác định chính xác mật độ giao thông trên đoạn đường dài</li>
                                    <li>Cần nhiều điểm đo để có dữ liệu đầy đủ cho mạng lưới đường</li>
                                    <li>Đo mật độ đòi hỏi ảnh chụp hoặc quan sát từ trên cao</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bảng điều khiển mô phỏng - chiếm 4/12 độ rộng màn hình lớn -->
            <div class="col-lg-4">
                <div class="card shadow mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h5 class="mb-0">Điều khiển mô phỏng</h5>
                    </div>
                    <div class="card-body p-2">
                        <!-- Hiển thị thông số và điều chỉnh tham số -->
                        <div class="row g-2">
                            <!-- Thông số đo lường -->
                            <div class="col-md-6 col-lg-12">
                                <div class="small">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Số xe đếm được (↑):</span>
                                        <span id="incoming-count" class="text-primary fw-bold">0 xe</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Số xe đếm được (↓):</span>
                                        <span id="outgoing-count" class="text-primary fw-bold">0 xe</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Thời gian quan sát:</span>
                                        <span id="observation-time" class="text-primary fw-bold">0 phút</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Kết quả tính toán -->
                            <div class="col-md-6 col-lg-12">
                                <div class="small bg-light p-2 rounded">
                                    <div class="d-flex justify-content-between">
                                        <span>Lưu lượng (q):</span>
                                        <span id="flow-rate" class="fw-bold calculated">4.0 xe/phút</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Điều chỉnh tham số -->
                        <div class="mt-2">
                            <div class="mb-2">
                                <label for="incoming-slider" class="form-label small mb-0">Số xe đến (10-60):</label>
                                <input type="range" class="form-range" id="incoming-slider" min="10" max="60" value="42"
                                    step="1">
                            </div>
                            <div class="mb-2">
                                <label for="outgoing-slider" class="form-label small mb-0">Số xe đi (5-40):</label>
                                <input type="range" class="form-range" id="outgoing-slider" min="5" max="40" value="18"
                                    step="1">
                            </div>
                            <div class="mb-2">
                                <label for="observation-time-slider" class="form-label small mb-0">Thời gian quan sát
                                    (phút):</label>
                                <input type="range" class="form-range" id="observation-time-slider" min="5" max="30"
                                    value="15" step="1">
                            </div>
                            <div class="d-flex gap-2">
                                <button id="start-button" class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="fas fa-play me-1"></i>Bắt đầu
                                </button>
                                <button id="reset-button" class="btn btn-secondary btn-sm flex-grow-1">
                                    <i class="fas fa-redo-alt me-1"></i>Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Giải thích công thức -->
            <div class="card shadow">
                <div class="card-header bg-success text-white py-2">
                    <h5 class="mb-0">Giải thích công thức</h5>
                </div>
                <div class="card-body p-2 small">
                    <p class="mb-1"><strong>Ký hiệu:</strong></p>
                    <ul class="mb-2 ps-3">
                        <li><strong>n</strong>: Số xe đi qua điểm đo</li>
                        <li><strong>T</strong>: Thời gian quan sát (phút)</li>
                    </ul>
                    <p class="mb-0">Phương pháp đứng yên chỉ cần đếm số lượng xe đi qua trạm (n) trong khoảng thời
                        gian quan sát (T) để tính lưu lượng giao thông (q = n/T).</p>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery và Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // PHẦN 1: KHỞI TẠO BIẾN VÀ PHẦN TỬ DOM
            // Tham chiếu đến các phần tử DOM
            const $probeCar = $('#probe-car');
            const $carsUp = $('.car-up');
            const $carsDown = $('.car-down');

            // Biến điều khiển mô phỏng
            let animationId = null;
            let isAnimating = false;
            let probeCarSpeed = 35; // km/h
            let incomingCount = 0; // số xe đến (cùng chiều) - bắt đầu từ 0
            let outgoingCount = 0; // số xe đi (ngược chiều) - bắt đầu từ 0
            let observationTime = 15; // phút
            let realIncomingCount = parseInt($('#incoming-slider').val()); // Giá trị từ slider
            let realOutgoingCount = parseInt($('#outgoing-slider').val()); // Giá trị từ slider

            // Thêm biến theo dõi cho hệ thống continuous spawning
            let carUpFastCounter = 0;
            let carUpSlowCounter = 0;
            let carDownFastCounter = 0;
            let carDownSlowCounter = 0;
            let spawnIntervalId = null;

            // Xác định vị trí vạch đỏ
            const countingLineX = 450; // Vị trí vạch đỏ theo trục X

            // Ẩn tất cả các xe mặc định
            $(document).ready(function () {
                $('#car-up-fast-1, #car-up-fast-2, #car-up-slow-1, #car-up-slow-2, #car-down-fast-1, #car-down-fast-2, #car-down-slow-1, #car-down-slow-2').css('visibility', 'hidden');
            });

            // PHẦN 2: TẠO VẠCH KẺ ĐƯỜNG ĐỨT ĐOẠN
            const roadWidth = $('.road').width();
            const spacing = roadWidth / 15;

            for (let i = 0; i < 15; i++) {
                $('.simulation-area').append(`<div class="road-marking-dashed" style="left: ${spacing * i + spacing / 2}px;"></div>`);
            }

            // PHẦN 3: HÀM TÍNH TOÁN
            // Tính lưu lượng giao thông (xe/phút)
            function calculateFlowRate() {
                // q = (Ma + Mw) / T
                return (incomingCount + outgoingCount) / observationTime;
            }

            // Tính mật độ giao thông (xe/km)
            function calculateDensity() {
                // k = (Ma - Mw) / (T × v_obs)
                // Chuyển đổi tốc độ từ km/h sang km/phút
                const probeSpeedInKmPerMin = probeCarSpeed / 60;
                return (incomingCount - outgoingCount) / (observationTime * probeSpeedInKmPerMin);
            }

            // Tính vận tốc dòng xe (km/h)
            function calculateSpeed() {
                const flowRate = calculateFlowRate(); // xe/phút
                const density = calculateDensity(); // xe/km

                // Kiểm tra để tránh chia cho 0 hoặc số âm
                if (density <= 0) {
                    return 0;
                }

                // Chuyển đổi flow rate từ xe/phút sang xe/giờ và chia cho mật độ (xe/km)
                return flowRate * 60 / density;
            }

            // PHẦN 4: CẬP NHẬT GIAO DIỆN
            // Cập nhật hiển thị các thông số
            function updateDisplayInfo() {
                // Cập nhật giá trị đầu vào
                $('#incoming-count').text(incomingCount + ' xe');
                $('#outgoing-count').text(outgoingCount + ' xe');
                $('#observation-time').text(observationTime + ' phút');

                // Tính toán và hiển thị kết quả
                const flowRate = calculateFlowRate();
                $('#flow-rate').text(flowRate.toFixed(1) + ' xe/phút');
            }

            // PHẦN 5: XỬ LÝ SỰ KIỆN SLIDER
            // Cập nhật khi số xe đến thay đổi
            $('#incoming-slider').on('input', function () {
                incomingCount = parseInt($(this).val());
                // Đảm bảo Ma >= Mw để mật độ không âm
                if (incomingCount < outgoingCount) {
                    outgoingCount = incomingCount;
                    $('#outgoing-slider').val(outgoingCount);
                }
                updateDisplayInfo();
            });

            // Cập nhật khi số xe đi thay đổi
            $('#outgoing-slider').on('input', function () {
                outgoingCount = parseInt($(this).val());
                // Đảm bảo Ma >= Mw
                if (outgoingCount > incomingCount) {
                    outgoingCount = incomingCount;
                    $(this).val(outgoingCount);
                }
                updateDisplayInfo();
            });

            // Cập nhật khi thời gian quan sát thay đổi
            $('#observation-time-slider').on('input', function () {
                observationTime = parseInt($(this).val());
                updateDisplayInfo();
            });

            // Cập nhật khi tốc độ xe thăm dò thay đổi
            $('#probe-speed-slider').on('input', function () {
                probeCarSpeed = parseInt($(this).val());
                updateDisplayInfo();

                // Nếu đang chạy animation và tốc độ về 0, đặt lại vị trí xe
                if (isAnimating && probeCarSpeed <= 1) {
                    resetCarPositions();
                    isAnimating = false;
                }
            });

            // PHẦN 6: XỬ LÝ SỰ KIỆN CÁC NÚT ĐIỀU KHIỂN
            // Bắt đầu mô phỏng
            $('#start-button').click(function () {
                if (isAnimating) {
                    // Nếu đang chạy, dừng lại
                    clearInterval(spawnIntervalId);
                    isAnimating = false;
                    $(this).html('<i class="fas fa-play me-1"></i>Bắt đầu');
                    return;
                }

                // Bắt đầu mô phỏng liên tục
                isAnimating = true;
                $(this).html('<i class="fas fa-pause me-1"></i>Tạm dừng');

                // Cuộn đến khu vực mô phỏng
                $('html, body').animate({
                    scrollTop: $('.simulation-area').offset().top - 20
                }, 500);

                // Đặt lại vị trí tất cả xe
                resetCarPositions();

                // Đặt lại bộ đếm thực tế
                incomingCount = 0;
                outgoingCount = 0;
                // Lấy giá trị mong muốn từ slider
                realIncomingCount = parseInt($('#incoming-slider').val());
                realOutgoingCount = parseInt($('#outgoing-slider').val());
                updateDisplayInfo();

                // Thiết lập spawning liên tục
                spawnIntervalId = setInterval(function () {
                    // Spawn xe đi lên làn nhanh
                    if (Math.random() < 0.3 && carUpFastCounter < realIncomingCount) { // Tăng từ 10% lên 30%
                        spawnUpFastCar();
                    }

                    // Spawn xe đi lên làn chậm
                    if (Math.random() < 0.25 && carUpSlowCounter < realIncomingCount) { // Tăng từ 8% lên 25%
                        spawnUpSlowCar();
                    }

                    // Spawn xe đi xuống làn nhanh
                    if (Math.random() < 0.3 && carDownFastCounter < realOutgoingCount) { // Tăng từ 10% lên 30%
                        spawnDownFastCar();
                    }

                    // Spawn xe đi xuống làn chậm
                    if (Math.random() < 0.25 && carDownSlowCounter < realOutgoingCount) { // Tăng từ 7% lên 25%
                        spawnDownSlowCar();
                    }

                }, 2500); // Giảm từ 3 giây xuống 2.5 giây (trung bình 2-3 giây)
            });

            // Hàm kiểm tra xem xe có đi qua vạch đỏ không
            function checkCarPassedCountingLine(carId, direction) {
                const $car = $(`#${carId}`);
                const carLeft = $car.position().left;
                const carWidth = $car.width();

                // Nếu xe đi lên (từ trái sang phải)
                if (direction === 'up') {
                    // Phần đầu xe vừa vượt qua vạch đỏ
                    if (carLeft <= countingLineX && carLeft + carWidth >= countingLineX) {
                        return !$car.data('counted');
                    }
                }
                // Nếu xe đi xuống (từ phải sang trái)
                else if (direction === 'down') {
                    // Phần đuôi xe vừa vượt qua vạch đỏ
                    if (carLeft <= countingLineX && carLeft + carWidth >= countingLineX) {
                        return !$car.data('counted');
                    }
                }

                return false;
            }

            // Thêm giới hạn số xe hiển thị trên mỗi làn
            function getLaneVehicleCount(laneClass) {
                return $(laneClass).length;
            }

            // Hàm tạo xe đi lên làn nhanh mới
            function spawnUpFastCar() {
                // Giới hạn số xe đồng thời trên làn
                if (getLaneVehicleCount('[id^="car-up-fast-dynamic-"]') >= 3) {
                    return;
                }

                carUpFastCounter++;
                const carId = `car-up-fast-dynamic-${carUpFastCounter}`;

                // Tạo phần tử xe mới
                const $newCar = $('<div>', {
                    id: carId,
                    class: 'car-up',
                    css: {
                        'top': '95px',
                        'left': '25px',  // Bắt đầu từ bên trái
                        'visibility': 'visible'
                    },
                    html: `<span>A${carUpFastCounter}</span>`
                });

                // Đánh dấu xe chưa được đếm
                $newCar.data('counted', false);

                // Thêm vào khu vực mô phỏng
                $('.simulation-area').append($newCar);

                // Thiết lập animation
                const speedFactor = 1.5 + (Math.random() * 0.5); // Tăng từ 70-85% lên 150-200%
                const carDuration = 15000 / (probeCarSpeed * speedFactor) * 35;

                $newCar.css({
                    'animation': `moveCarUp ${carDuration}ms linear forwards`
                });

                // Theo dõi vị trí xe để đếm khi đi qua vạch đỏ
                const checkInterval = setInterval(function () {
                    if (checkCarPassedCountingLine(carId, 'up')) {
                        incomingCount++;
                        updateDisplayInfo();
                        $newCar.data('counted', true);
                    }
                }, 50);

                // Xóa xe và clear interval khi animation kết thúc
                setTimeout(function () {
                    clearInterval(checkInterval);
                    $newCar.remove();
                }, carDuration + 500);
            }

            // Hàm tạo xe đi lên làn chậm mới
            function spawnUpSlowCar() {
                // Giới hạn số xe đồng thời trên làn
                if (getLaneVehicleCount('[id^="car-up-slow-dynamic-"]') >= 3) {
                    return;
                }

                carUpSlowCounter++;
                const carId = `car-up-slow-dynamic-${carUpSlowCounter}`;

                // Tạo phần tử xe mới
                const $newCar = $('<div>', {
                    id: carId,
                    class: 'car-up',
                    css: {
                        'top': '155px',
                        'left': '25px',  // Bắt đầu từ bên trái
                        'visibility': 'visible'
                    },
                    html: `<span>AS${carUpSlowCounter}</span>`
                });

                // Đánh dấu xe chưa được đếm
                $newCar.data('counted', false);

                // Thêm vào khu vực mô phỏng
                $('.simulation-area').append($newCar);

                // Thiết lập animation với tốc độ ngẫu nhiên
                const speedFactor = 2.0 + (Math.random() * 0.5); // Tăng từ 115-140% lên 200-250%
                const carDuration = 15000 / (probeCarSpeed * speedFactor) * 35;

                $newCar.css({
                    'animation': `moveCarUp ${carDuration}ms linear forwards`
                });

                // Theo dõi vị trí xe để đếm khi đi qua vạch đỏ
                const checkInterval = setInterval(function () {
                    if (checkCarPassedCountingLine(carId, 'up')) {
                        incomingCount++;
                        updateDisplayInfo();
                        $newCar.data('counted', true);
                    }
                }, 50);

                // Xóa xe và clear interval khi animation kết thúc
                setTimeout(function () {
                    clearInterval(checkInterval);
                    $newCar.remove();
                }, carDuration + 500);
            }

            // Hàm tạo xe đi xuống làn nhanh mới
            function spawnDownFastCar() {
                // Giới hạn số xe đồng thời trên làn
                if (getLaneVehicleCount('[id^="car-down-fast-dynamic-"]') >= 3) {
                    return;
                }

                carDownFastCounter++;
                const carId = `car-down-fast-dynamic-${carDownFastCounter}`;

                // Tạo phần tử xe mới
                const $newCar = $('<div>', {
                    id: carId,
                    class: 'car-down',
                    css: {
                        'top': '215px',
                        'left': 'calc(100% - 150px)', // Bắt đầu từ bên phải
                        'visibility': 'visible'
                    },
                    html: `<span>B${carDownFastCounter}</span>`
                });

                // Đánh dấu xe chưa được đếm
                $newCar.data('counted', false);

                // Thêm vào khu vực mô phỏng
                $('.simulation-area').append($newCar);

                // Thiết lập animation
                const relativeSpeed = calculateSpeed() + probeCarSpeed;
                const speedVariation = 1.7 + (Math.random() * 0.3); // Tăng từ 90-110% lên 170-200%
                const carSpeed = relativeSpeed * speedVariation;
                const carDuration = 15000 / carSpeed * 87;

                $newCar.css({
                    'animation': `moveCarDown ${carDuration}ms linear forwards`
                });

                // Theo dõi vị trí xe để đếm khi đi qua vạch đỏ
                const checkInterval = setInterval(function () {
                    if (checkCarPassedCountingLine(carId, 'down')) {
                        outgoingCount++;
                        updateDisplayInfo();
                        $newCar.data('counted', true);
                    }
                }, 50);

                // Xóa xe và clear interval khi animation kết thúc
                setTimeout(function () {
                    clearInterval(checkInterval);
                    $newCar.remove();
                }, carDuration + 500);
            }

            // Hàm tạo xe đi xuống làn chậm mới
            function spawnDownSlowCar() {
                // Giới hạn số xe đồng thời trên làn
                if (getLaneVehicleCount('[id^="car-down-slow-dynamic-"]') >= 3) {
                    return;
                }

                carDownSlowCounter++;
                const carId = `car-down-slow-dynamic-${carDownSlowCounter}`;

                // Tạo phần tử xe mới
                const $newCar = $('<div>', {
                    id: carId,
                    class: 'car-down',
                    css: {
                        'top': '275px',
                        'left': 'calc(100% - 150px)', // Bắt đầu từ bên phải
                        'visibility': 'visible'
                    },
                    html: `<span>BS${carDownSlowCounter}</span>`
                });

                // Đánh dấu xe chưa được đếm
                $newCar.data('counted', false);

                // Thêm vào khu vực mô phỏng
                $('.simulation-area').append($newCar);

                // Thiết lập animation
                const relativeSpeed = calculateSpeed() + probeCarSpeed;
                const speedVariation = 1.5 + (Math.random() * 0.2); // Tăng từ 70-90% lên 150-170%
                const carSpeed = relativeSpeed * speedVariation;
                const carDuration = 15000 / carSpeed * 87;

                $newCar.css({
                    'animation': `moveCarDown ${carDuration}ms linear forwards`
                });

                // Theo dõi vị trí xe để đếm khi đi qua vạch đỏ
                const checkInterval = setInterval(function () {
                    if (checkCarPassedCountingLine(carId, 'down')) {
                        outgoingCount++;
                        updateDisplayInfo();
                        $newCar.data('counted', true);
                    }
                }, 50);

                // Xóa xe và clear interval khi animation kết thúc
                setTimeout(function () {
                    clearInterval(checkInterval);
                    $newCar.remove();
                }, carDuration + 500);
            }

            // Sửa đổi hàm reset để xử lý xe động
            function resetCarPositions() {
                // Đặt lại bộ đếm
                carUpFastCounter = 0;
                carUpSlowCounter = 0;
                carDownFastCounter = 0;
                carDownSlowCounter = 0;
                incomingCount = 0;
                outgoingCount = 0;

                // Xóa tất cả xe động
                $('[id^="car-up-fast-dynamic"], [id^="car-up-slow-dynamic"], [id^="car-down-fast-dynamic"], [id^="car-down-slow-dynamic"]').remove();

                // Đặt lại vị trí xe thăm dò nếu có
                if ($probeCar.length) {
                    $probeCar.css({
                        'animation': 'none',
                        'left': '25px',
                        'visibility': 'visible'
                    });
                }

                // Cập nhật hiển thị
                updateDisplayInfo();
            }

            // Điều chỉnh nút reset để dừng spawning
            $('#reset-button, #mobile-restart-button').click(function () {
                // Dừng spawning liên tục
                clearInterval(spawnIntervalId);
                isAnimating = false;
                $('#start-button').html('<i class="fas fa-play me-1"></i>Bắt đầu');

                // Đặt lại vị trí tất cả xe
                resetCarPositions();

                // Đặt lại bộ đếm theo slider
                realIncomingCount = parseInt($('#incoming-slider').val());
                realOutgoingCount = parseInt($('#outgoing-slider').val());
                incomingCount = 0;
                outgoingCount = 0;
                updateDisplayInfo();
            });

            // PHẦN 7: KHỞI TẠO BAN ĐẦU
            // Cập nhật hiển thị ban đầu
            updateDisplayInfo();

            // Xử lý đóng mở bảng công thức
            $('#close-formula').click(function () {
                $('.formula-box').hide();
            });

            // Thêm nút để hiển thị lại công thức
            $('.card-body.simulation-area').append('<button class="btn btn-sm btn-success position-absolute" style="bottom: 10px; right: 10px; z-index: 1000;" id="show-formula"><i class="fas fa-calculator me-1"></i>Công thức</button>');

            // Xử lý khi click vào nút hiển thị lại
            $('#show-formula').click(function () {
                $('.formula-box').show();
            });
        });
    </script>
</body>

</html>